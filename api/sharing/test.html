<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sharing API Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Sharing API Test Suite</h1>
        
        <div class="test-section">
            <h3>üìã Instructions</h3>
            <p><strong>Before running tests:</strong></p>
            <ol>
                <li>Make sure you're logged into the main app at <code>localhost:3000</code></li>
                <li>Keep that tab open (it maintains your authentication session)</li>
                <li>Run the "Basic API Connection Test" first</li>
                <li>If authentication fails, log in to the main app and try again</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>1. Basic API Connection Test</h3>
            <p>Test if the API functions are loaded and working.</p>
            <button onclick="runBasicTest()">Run Basic Test</button>
            <div id="basic-status"></div>
            <div id="basic-output" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. Test with Real User Data</h3>
            <p>Test API functions with an actual user ID from your database.</p>
            <input type="text" id="userId" placeholder="Enter user ID" />
            <button onclick="runRealDataTest()">Test with Real Data</button>
            <div id="realdata-status"></div>
            <div id="realdata-output" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. Trainer Invitation Flow</h3>
            <p>Test the complete trainer invitation process (requires real user IDs).</p>
            <button onclick="runTrainerTest()">Run Trainer Test</button>
            <div id="trainer-status"></div>
            <div id="trainer-output" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. Client Invitation Flow</h3>
            <p>Test the complete client invitation process (requires real user IDs).</p>
            <button onclick="runClientTest()">Run Client Test</button>
            <div id="client-status"></div>
            <div id="client-output" class="console-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. Manual Console Testing</h3>
            <p>Open browser console (F12) and use these functions:</p>
            <ul>
                <li><code>testAPI()</code> - Basic API test</li>
                <li><code>testWithRealData('user-id')</code> - Test with real data</li>
                <li><code>testTrainerInvitation()</code> - Trainer invitation flow</li>
                <li><code>testClientInvitation()</code> - Client invitation flow</li>
            </ul>
        </div>
    </div>

    <script type="module">
        // Import the test functions and Supabase client
        import { 
            createTrainerInvite,
            createClientInvite,
            acceptSharingRequest,
            declineSharingRequest,
            getPendingRequests,
            getPendingRequestCount,
            createLegacyShare,
            updateSharePermissions,
            revokeShare,
            getOwnedShares,
            getDelegateShares,
            canManageAccount,
            getAllSharingRelationships
        } from './index.js';
        
        // Import Supabase client
        import { supabase } from '../../src/supabaseClient.js';
        
        // Make Supabase available globally
        window.supabase = supabase;

        // Test data
        const TEST_DATA = {
            trainerId: 'trainer-user-id',
            clientId: 'client-user-id',
            trainerEmail: 'trainer@example.com',
            clientEmail: 'client@example.com'
        };

        // Make functions available globally
        window.sharingAPI = {
            createTrainerInvite,
            createClientInvite,
            acceptSharingRequest,
            declineSharingRequest,
            getPendingRequests,
            getPendingRequestCount,
            createLegacyShare,
            updateSharePermissions,
            revokeShare,
            getOwnedShares,
            getDelegateShares,
            canManageAccount,
            getAllSharingRelationships
        };

        // Test functions
        window.testAPI = async () => {
            console.log('üß™ Testing API connection...');
            
            try {
                console.log('‚úÖ API loaded successfully');
                console.log('Available functions:', Object.keys(window.sharingAPI));
                
                // Check if we have a valid session
                const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();
                
                if (sessionError) {
                    console.warn('‚ö†Ô∏è Session error:', sessionError.message);
                    return { 
                        success: false, 
                        error: `Authentication error: ${sessionError.message}. Please log in to the main app first.`,
                        needsAuth: true
                    };
                }
                
                if (!session) {
                    console.warn('‚ö†Ô∏è No active session found');
                    return { 
                        success: false, 
                        error: 'No active session found. Please log in to the main app first.',
                        needsAuth: true
                    };
                }
                
                console.log('‚úÖ Valid session found for user:', session.user.email);
                
                // Test a simple function with the actual user ID
                const count = await window.sharingAPI.getPendingRequestCount(session.user.id);
                console.log('‚úÖ API call successful, pending count:', count);
                
                return { 
                    success: true, 
                    api: window.sharingAPI,
                    userId: session.user.id,
                    userEmail: session.user.email
                };
            } catch (error) {
                console.error('‚ùå API test failed:', error);
                return { success: false, error: error.message };
            }
        };

        window.testWithRealData = async (userId) => {
            console.log('üß™ Testing with real user data...');
            
            try {
                // Test getting pending requests
                const pendingRequests = await window.sharingAPI.getPendingRequests(userId);
                console.log('‚úÖ Pending requests:', pendingRequests);
                
                // Test getting request count
                const count = await window.sharingAPI.getPendingRequestCount(userId);
                console.log('‚úÖ Pending request count:', count);
                
                // Test getting owned shares
                const ownedShares = await window.sharingAPI.getOwnedShares(userId);
                console.log('‚úÖ Owned shares:', ownedShares);
                
                // Test getting delegate shares
                const delegateShares = await window.sharingAPI.getDelegateShares(userId);
                console.log('‚úÖ Delegate shares:', delegateShares);
                
                return {
                    success: true,
                    pendingRequests,
                    count,
                    ownedShares,
                    delegateShares
                };
                
            } catch (error) {
                console.error('‚ùå Real data test failed:', error);
                return { success: false, error: error.message };
            }
        };

        window.testTrainerInvitation = async () => {
            console.log('üß™ Testing trainer invitation flow...');
            
            try {
                // 1. Create trainer invitation
                console.log('1. Creating trainer invitation...');
                const invitation = await window.sharingAPI.createTrainerInvite(
                    TEST_DATA.clientEmail,
                    TEST_DATA.trainerId,
                    {
                        can_create_routines: true,
                        can_start_workouts: true,
                        can_review_history: false
                    }
                );
                console.log('‚úÖ Trainer invitation created:', invitation);

                // 2. Get pending requests for client
                console.log('2. Getting pending requests for client...');
                const pendingRequests = await window.sharingAPI.getPendingRequests(TEST_DATA.clientId);
                console.log('‚úÖ Pending requests:', pendingRequests);

                // 3. Get pending request count
                console.log('3. Getting pending request count...');
                const count = await window.sharingAPI.getPendingRequestCount(TEST_DATA.clientId);
                console.log('‚úÖ Pending request count:', count);

                // 4. Accept the invitation
                console.log('4. Accepting invitation...');
                const acceptedShare = await window.sharingAPI.acceptSharingRequest(
                    invitation.id,
                    TEST_DATA.clientId
                );
                console.log('‚úÖ Invitation accepted:', acceptedShare);

                // 5. Verify management permissions
                console.log('5. Verifying management permissions...');
                const canManage = await window.sharingAPI.canManageAccount(TEST_DATA.trainerId, TEST_DATA.clientId);
                console.log('‚úÖ Can manage account:', canManage);

                return {
                    success: true,
                    invitation,
                    acceptedShare,
                    canManage
                };

            } catch (error) {
                console.error('‚ùå Trainer invitation test failed:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        };

        window.testClientInvitation = async () => {
            console.log('üß™ Testing client invitation flow...');
            
            try {
                // 1. Create client invitation
                console.log('1. Creating client invitation...');
                const invitation = await window.sharingAPI.createClientInvite(
                    TEST_DATA.trainerEmail,
                    TEST_DATA.clientId,
                    {
                        can_create_routines: true,
                        can_start_workouts: true,
                        can_review_history: true
                    }
                );
                console.log('‚úÖ Client invitation created:', invitation);

                // 2. Get pending requests for trainer
                console.log('2. Getting pending requests for trainer...');
                const pendingRequests = await window.sharingAPI.getPendingRequests(TEST_DATA.trainerId);
                console.log('‚úÖ Pending requests:', pendingRequests);

                // 3. Accept the invitation
                console.log('3. Accepting invitation...');
                const acceptedShare = await window.sharingAPI.acceptSharingRequest(
                    invitation.id,
                    TEST_DATA.trainerId
                );
                console.log('‚úÖ Invitation accepted:', acceptedShare);

                return {
                    success: true,
                    invitation,
                    acceptedShare
                };

            } catch (error) {
                console.error('‚ùå Client invitation test failed:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        };

        // UI helper functions
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showOutput(elementId, content) {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.style.display = 'block';
        }

        window.runBasicTest = async () => {
            showStatus('basic-status', 'Running basic test...', 'info');
            const result = await window.testAPI();
            
            if (result.success) {
                showStatus('basic-status', `‚úÖ Basic test passed! Logged in as: ${result.userEmail}`, 'success');
                showOutput('basic-output', JSON.stringify(result, null, 2));
                
                // Auto-fill the user ID field
                document.getElementById('userId').value = result.userId;
            } else {
                if (result.needsAuth) {
                    showStatus('basic-status', `‚ùå Authentication required: ${result.error}`, 'error');
                    showOutput('basic-output', `To fix this:\n1. Open the main app (localhost:3000)\n2. Log in with your account\n3. Come back to this test page\n4. Run the test again`);
                } else {
                    showStatus('basic-status', `‚ùå Basic test failed: ${result.error}`, 'error');
                    showOutput('basic-output', result.error);
                }
            }
        };

        window.runRealDataTest = async () => {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                showStatus('realdata-status', 'Please enter a user ID', 'error');
                return;
            }

            showStatus('realdata-status', 'Testing with real data...', 'info');
            const result = await window.testWithRealData(userId);
            
            if (result.success) {
                showStatus('realdata-status', '‚úÖ Real data test passed!', 'success');
                showOutput('realdata-output', JSON.stringify(result, null, 2));
            } else {
                showStatus('realdata-status', `‚ùå Real data test failed: ${result.error}`, 'error');
                showOutput('realdata-output', result.error);
            }
        };

        window.runTrainerTest = async () => {
            showStatus('trainer-status', 'Running trainer invitation test...', 'info');
            const result = await window.testTrainerInvitation();
            
            if (result.success) {
                showStatus('trainer-status', '‚úÖ Trainer test passed!', 'success');
                showOutput('trainer-output', JSON.stringify(result, null, 2));
            } else {
                showStatus('trainer-status', `‚ùå Trainer test failed: ${result.error}`, 'error');
                showOutput('trainer-output', result.error);
            }
        };

        window.runClientTest = async () => {
            showStatus('client-status', 'Running client invitation test...', 'info');
            const result = await window.testClientInvitation();
            
            if (result.success) {
                showStatus('client-status', '‚úÖ Client test passed!', 'success');
                showOutput('client-output', JSON.stringify(result, null, 2));
            } else {
                showStatus('client-status', `‚ùå Client test failed: ${result.error}`, 'error');
                showOutput('client-output', result.error);
            }
        };

        // Show initial status
        showStatus('basic-status', 'Ready to test! Click "Run Basic Test" to start.', 'info');
    </script>
</body>
</html>
